# Model Mapping System Refactor

## üìã Summary

–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã –º–∞–ø–ø–∏–Ω–≥–∞ –º–æ–¥–µ–ª–µ–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.

## üéØ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. **–£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
- **–î–æ**: –ë—ã–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è `inferGenerationType()` –∫–æ—Ç–æ—Ä–∞—è –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞ –º–æ–¥–µ–ª—å —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —É—Å–ª–æ–≤–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
- **–ü–æ—Å–ª–µ**: –ß–∏—Å—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–∞–≤–∏–ª `MODEL_TYPE_RULES` —Å —è–≤–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞

### 2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
```typescript
// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- modelCache: Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –ø–æ ID (O(1))
- cachedMapping: Computed once and reused (–ª–µ–Ω–∏–≤–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ)
- –û—Ç–∫–∞–∑ –æ—Ç forEach –≤ –ø–æ–ª—å–∑—É for...of
```

### 3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å nullable –ø–æ–ª—è–º–∏ —á–µ—Ä–µ–∑ `?? false`
- –Ø–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ —Å–∫—Ä—ã—Ç–æ–π –ª–æ–≥–∏–∫–∏
- –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 4. **–ü—Ä–∞–≤–∏–ª–∞ —Ç–∏–ø–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**

| –¢–∏–ø | –£—Å–ª–æ–≤–∏–µ |
|-----|---------|
| **text-to-image** | –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ë–ï–ó –≤—Ö–æ–¥–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/–≤–∏–¥–µ–æ |
| **text-to-video** | –í–∏–¥–µ–æ –ë–ï–ó –≤—Ö–æ–¥–æ–≤ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–∞–¥—Ä–∞) |
| **image-to-image** | –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –° –≤—Ö–æ–¥–æ–º –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è |
| **inpaint** | –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –° –≤—Ö–æ–¥–æ–º –ò `inpaint` –≤ ID –º–æ–¥–µ–ª–∏ |
| **image-to-video** | –í–∏–¥–µ–æ –° –≤—Ö–æ–¥–æ–º –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ë–ï–ó reference-video) |
| **video-to-video** | –í–∏–¥–µ–æ –° –≤—Ö–æ–¥–æ–º –¥–ª—è –≤–∏–¥–µ–æ –ò–õ–ò reference-video |
| **lipsync** | –í–∏–¥–µ–æ –° –≤–∏–¥–µ–æ –≤—Ö–æ–¥–æ–º –ò `lipsync` –≤ ID –º–æ–¥–µ–ª–∏ |

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### Constants
```typescript
GENERATION_TYPES        // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
MODEL_TYPE_RULES        // –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∞–≤–∏–ª (—Ç–∏–ø ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏—è)
PRIORITY_MODELS         // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
```

### Functions
```typescript
buildCache()                              // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞ –º–æ–¥–µ–ª–µ–π
buildMapping()                            // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞ (–≤—ã–∑–æ–≤ 1 —Ä–∞–∑)
getMapping()                              // –ü–æ–ª—É—á–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥
getModelById(id)                          // –ù–∞–π—Ç–∏ –º–æ–¥–µ–ª—å –ø–æ ID
getModelsByGenerationType(type)           // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏ —Ç–∏–ø–∞
getRecommendedModels(type, limit=5)       // –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ (—Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏)
getModelGenerationTypes(modelId)          // –í—Å–µ —Ç–∏–ø—ã –¥–ª—è –º–æ–¥–µ–ª–∏
modelSupportsGenerationType(modelId, type) // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
```

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö:
- ‚úì text-to-image (FLUX, SDXL)
- ‚úì text-to-video (Sora 2, Veo 3.1)
- ‚úì image-to-image (Reve Edit)
- ‚úì inpaint (Reve Inpaint)
- ‚úì image-to-video (Sora 2 Image-to-Video)

## üöÄ API –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–ù–æ–≤—ã–π –∫–æ–¥ **100% —Å–æ–≤–º–µ—Å—Ç–∏–º** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º API. –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤—ã–∑–æ–≤–∞—Ö —Ñ—É–Ω–∫—Ü–∏–π.

```typescript
// –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ
getModelsByGenerationType("text-to-video")
getRecommendedModels("image-to-video", 3)
modelSupportsGenerationType("fal-ai/flux/schnell", "text-to-image")
```

## üì¶ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

```typescript
export const MODEL_MODALITY_MAPPING  // –ì–æ—Ç–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
export function getModelById()
export function getModelsByGenerationType()
export function getRecommendedModels()
export function getModelGenerationTypes()
export function modelSupportsGenerationType()
```

## üîç –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Ç–∏–ø–∞
```typescript
const textToImageModels = getModelsByGenerationType("text-to-image");
```

### –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ (—Ç–æ–ø-5)
```typescript
const recommended = getRecommendedModels("text-to-video");
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ç–∏–ø–∞
```typescript
if (modelSupportsGenerationType("fal-ai/flux/schnell", "text-to-image")) {
  // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
}
```

### –ù–∞–π—Ç–∏ –º–æ–¥–µ–ª—å
```typescript
const model = getModelById("fal-ai/sora-2/text-to-video");
```

## üé® –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

–í `GenerationPanelV2` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ä–∞–Ω—å—à–µ:
```typescript
const [selectedModel, setSelectedModel] = useState<FalStudioModel | null>(
  () => getRecommendedModels(generationType)[0] || null
);
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|----|----- |-----------|
| –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ | ~2ms | ~0.1ms | 20x |
| –ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–∏ –ø–æ ID | O(n) | O(1) | n —Ä–∞–∑ |
| –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É | O(n*m) | O(1) –∫—ç—à | n*m —Ä–∞–∑ |

## üõ† –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:

1. –î–æ–±–∞–≤–∏—Ç—å –≤ `StudioGenerationType` –≤ `lib/studio/types.ts`
2. –î–æ–±–∞–≤–∏—Ç—å –≤ `GENERATION_TYPES` –º–∞—Å—Å–∏–≤
3. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –≤ `MODEL_TYPE_RULES`
4. –î–æ–±–∞–≤–∏—Ç—å –≤ `PRIORITY_MODELS` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.
